<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Levy">
<meta name="dcterms.date" content="2024-02-13">

<title>Chris Levy - DSPy</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Chris Levy</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/DrChrisLevy" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/cleavey1985" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <h1 class="title">DSPy</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Chris Levy </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 13, 2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">February 13, 2024</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro">Intro</a></li>
  <li><a href="#env-setup" id="toc-env-setup" class="nav-link" data-scroll-target="#env-setup">ENV Setup</a></li>
  <li><a href="#big-bench-hard-dataset---penguins-in-a-table---example" id="toc-big-bench-hard-dataset---penguins-in-a-table---example" class="nav-link" data-scroll-target="#big-bench-hard-dataset---penguins-in-a-table---example">BIG-Bench Hard Dataset - Penguins In a Table - Example</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">




<section id="intro" class="level1">
<h1>Intro</h1>
<p><a href="https://github.com/stanfordnlp/dspy"><code>DSPy</code></a> kept popping up on my X timeline and I thought it looked pretty interesting, so I decided to take a few days to look into it. I didn’t get super deep into it yet, but I think I have a high level understanding. The library is fairly new IMO (as of writing this). There is excitement around it though and a growing community. I am hopeful that the documentation and library will continue to improve throughout the year. If you are completely new to <code>DSPy</code> I would suggest the following resources below.</p>
<ul>
<li>Read through the newer documentation <a href="https://dspy-docs.vercel.app/docs/intro">here</a>.</li>
<li>Checkout the README from <a href="https://github.com/stanfordnlp/dspy"><code>DSPY</code> GitHub repo</a> and the examples there.</li>
<li>Try and code up some simple examples on your own data.</li>
<li>Checkout the <a href="https://discord.gg/s7cFzpw3Mj">Discord server</a>.</li>
<li>Skim through or read some of the associated papers (see the paper links on the <code>DSPy</code> repo <a href="https://github.com/stanfordnlp/dspy?tab=readme-ov-file#dspy-programmingnot-promptingfoundation-models">README</a>). For example:
<ul>
<li><a href="https://arxiv.org/abs/2310.03714">DSPy: Compiling Declarative Language Model Calls into Self-Improving Pipelines</a>(<span class="citation" data-cites="khattab2023dspy">Khattab et al. (<a href="#ref-khattab2023dspy" role="doc-biblioref">2023</a>)</span>)</li>
<li><a href="https://arxiv.org/abs/2312.13382">DSPy Assertions: Computational Constraints for Self-Refining Language Model Pipelines</a>(<span class="citation" data-cites="singhvi2024dspy">Singhvi et al. (<a href="#ref-singhvi2024dspy" role="doc-biblioref">2024</a>)</span>)</li>
</ul></li>
<li>There are also some decent videos on YouTube. Simply Search for <code>DSPy</code> LLM etc.</li>
<li>Follow <a href="https://twitter.com/lateinteraction">Omar Khattab</a></li>
</ul>
</section>
<section id="env-setup" class="level1">
<h1>ENV Setup</h1>
<pre><code>python3 -m venv env
source env/bin/activate
pip install dspy-ai
pip install openai --upgrade
pip install --upgrade notebook ipywidgets</code></pre>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"OPENAI_API_KEY"</span>] <span class="op">=</span> <span class="st">"YOUR_OPENAI_API_KEY"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="big-bench-hard-dataset---penguins-in-a-table---example" class="level1">
<h1>BIG-Bench Hard Dataset - Penguins In a Table - Example</h1>
<p>Within the <a href="https://github.com/suzgunmirac/BIG-Bench-Hard">BIG-Bench Hard dataset</a> <span class="citation" data-cites="suzgun2022challenging">(<a href="#ref-suzgun2022challenging" role="doc-biblioref">Suzgun et al. 2022</a>)</span> there are various tasks. You can use one of these strings when using <code>load_dataset</code> to load in the corresponding records for that task.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>[<span class="st">'tracking_shuffled_objects_seven_objects'</span>, <span class="st">'salient_translation_error_detection'</span>, <span class="st">'tracking_shuffled_objects_three_objects'</span>, <span class="st">'geometric_shapes'</span>, <span class="st">'object_counting'</span>, <span class="st">'word_sorting'</span>, <span class="st">'logical_deduction_five_objects'</span>, <span class="st">'hyperbaton'</span>, <span class="st">'sports_understanding'</span>, <span class="st">'logical_deduction_seven_objects'</span>, <span class="st">'multistep_arithmetic_two'</span>, <span class="st">'ruin_names'</span>, <span class="st">'causal_judgement'</span>, <span class="st">'logical_deduction_three_objects'</span>, <span class="st">'formal_fallacies'</span>, <span class="st">'snarks'</span>, <span class="st">'boolean_expressions'</span>, <span class="st">'reasoning_about_colored_objects'</span>, <span class="st">'dyck_languages'</span>, <span class="st">'navigate'</span>, <span class="st">'disambiguation_qa'</span>, <span class="st">'temporal_sequences'</span>, <span class="st">'web_of_lies'</span>, <span class="st">'tracking_shuffled_objects_five_objects'</span>, <span class="st">'penguins_in_a_table'</span>, <span class="st">'movie_recommendation'</span>, <span class="st">'date_understanding'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will use the <code>penguins_in_a_table</code> task.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.506173Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:42.284202Z&quot;}" data-execution_count="1">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> load_dataset(<span class="st">"maveriq/bigbenchhard"</span>, <span class="st">"penguins_in_a_table"</span>)[<span class="st">"train"</span>]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> [dspy.Example({<span class="st">"question"</span>: r[<span class="st">"input"</span>], <span class="st">"answer"</span>: r[<span class="st">"target"</span>]}).with_inputs(<span class="st">"question"</span>) <span class="cf">for</span> r <span class="kw">in</span> ds]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span><span class="bu">len</span>(examples)<span class="sc">}</span><span class="ss"> examples."</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>trainset <span class="op">=</span> examples[<span class="dv">0</span>:<span class="dv">20</span>]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>valset <span class="op">=</span> examples[<span class="dv">20</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>There are 146 examples.</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.514379Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.508625Z&quot;}" data-execution_count="2">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>example <span class="op">=</span> trainset[<span class="dv">10</span>]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k, v <span class="kw">in</span> example.items():</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>k<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">:</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
QUESTION:

Here is a table where the first line is a header and each subsequent line is a penguin:  name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15  For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm.  We then delete the penguin named Bernard from the table.
How many penguins are more than 8 years old?
Options:
(A) 1
(B) 2
(C) 3
(D) 4
(E) 5

ANSWER:

(A)</code></pre>
</div>
</div>
<p>We will use the <code>DSPy</code> OpenAI connector to make calls to gpt-3.5. Note that <code>DSPy</code> caches API calls so that subsequent calls with the same input will read from the cache instead of calling the OpenAI API a second time.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.516463Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.512251Z&quot;}" data-execution_count="3">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> dspy.OpenAI(model<span class="op">=</span><span class="st">"gpt-3.5-turbo-0125"</span>, max_tokens<span class="op">=</span><span class="dv">250</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>dspy.settings.configure(lm<span class="op">=</span>llm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can test that the calls to OpenAI are working:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.524831Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.517046Z&quot;}" data-execution_count="4">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>llm(<span class="st">"Testing testing, is anyone out there?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>["Hello! I'm here to help. What can I assist you with today?"]</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.568404Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.527742Z&quot;}" data-execution_count="5">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>llm(example.question)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>['There are 2 penguins who are more than 8 years old: Vincent (9 years old) and Gwen (8 years old). \n\nTherefore, the answer is (B) 2.']</code></pre>
</div>
</div>
<p>At any point we can look at the last <code>n</code> calls to the llm:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.568562Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.533442Z&quot;}" data-execution_count="6">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>llm.inspect_history(n<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>



Testing testing, is anyone out there? Hello! I'm here to help. What can I assist you with today?







Here is a table where the first line is a header and each subsequent line is a penguin:  name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15  For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm.  We then delete the penguin named Bernard from the table.
How many penguins are more than 8 years old?
Options:
(A) 1
(B) 2
(C) 3
(D) 4
(E) 5 There are 2 penguins who are more than 8 years old: Vincent (9 years old) and Gwen (8 years old). 

Therefore, the answer is (B) 2.

</code></pre>
</div>
</div>
<p>Our evaluation metric will check if the llm output contains the correct multiple choice answer. To define an evaluation metric in <code>DSPy</code> we create a function like the example below. The first two inputs should be instances of <code>dspy.Example</code>. The metric function can contain any logic you need to evaluate your task. You can read more about the <code>trace</code> argument in the <a href="https://dspy-docs.vercel.app/docs/building-blocks/metrics#simple-metrics">documentation</a>. It needs to be there, even if not explicitly using it.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.568665Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.541505Z&quot;}" data-execution_count="7">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eval_metric(true, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> prediction.answer</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    matches <span class="op">=</span> re.findall(<span class="vs">r"\([A-Z]\)"</span>, pred)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    parsed_answer <span class="op">=</span> matches[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> matches <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parsed_answer <span class="op">==</span> true.answer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We set up an evaluation pipeline:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.569208Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.550483Z&quot;}" data-execution_count="8">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>evaluate <span class="op">=</span> Evaluate(devset<span class="op">=</span>valset, metric<span class="op">=</span>eval_metric, num_threads<span class="op">=</span><span class="dv">6</span>, display_progress<span class="op">=</span><span class="va">True</span>, display_table<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is a simple module in <code>DSPy</code> for basic question and answer.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.569242Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.558449Z&quot;}" data-execution_count="9">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BasicQA(dspy.Module):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.prog <span class="op">=</span> dspy.Predict(<span class="st">"question -&gt; answer"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, question):</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.prog(question<span class="op">=</span>question)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>basic_qa <span class="op">=</span> BasicQA()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>forward</code> method calls <code>__call__</code> similar to how things work in pytorch.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.569929Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.561051Z&quot;}" data-execution_count="10">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> basic_qa(question<span class="op">=</span>example.question)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">QUESTION:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(example.question)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">ANSWER:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(example.answer)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">PREDICTION:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pred.answer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
QUESTION:

Here is a table where the first line is a header and each subsequent line is a penguin:  name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15  For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm.  We then delete the penguin named Bernard from the table.
How many penguins are more than 8 years old?
Options:
(A) 1
(B) 2
(C) 3
(D) 4
(E) 5

ANSWER:

(A)

PREDICTION:

(B) 2</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.569992Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.565295Z&quot;}" data-execution_count="11">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>eval_metric(example, pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>False</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.581515Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.568916Z&quot;}" data-execution_count="12">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>llm.inspect_history(n<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>



Given the fields `question`, produce the fields `answer`.

---

Follow the following format.

Question: ${question}
Answer: ${answer}

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. We then delete the penguin named Bernard from the table. How many penguins are more than 8 years old? Options: (A) 1 (B) 2 (C) 3 (D) 4 (E) 5
Answer: (B) 2

</code></pre>
</div>
</div>
<p>Now we can pass each example question through the LLM in the validation set and check if we get the correct answer:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:44.785509Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.576192Z&quot;}" data-execution_count="14">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>evaluate(basic_qa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 44 / 126  (34.9%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_672e4 th {
  text-align: left;
}
#T_672e4 td {
  text-align: left;
}
#T_672e4_row0_col0, #T_672e4_row0_col1, #T_672e4_row0_col2, #T_672e4_row0_col3, #T_672e4_row1_col0, #T_672e4_row1_col1, #T_672e4_row1_col2, #T_672e4_row1_col3, #T_672e4_row2_col0, #T_672e4_row2_col1, #T_672e4_row2_col2, #T_672e4_row2_col3, #T_672e4_row3_col0, #T_672e4_row3_col1, #T_672e4_row3_col2, #T_672e4_row3_col3, #T_672e4_row4_col0, #T_672e4_row4_col1, #T_672e4_row4_col2, #T_672e4_row4_col3, #T_672e4_row5_col0, #T_672e4_row5_col1, #T_672e4_row5_col2, #T_672e4_row5_col3, #T_672e4_row6_col0, #T_672e4_row6_col1, #T_672e4_row6_col2, #T_672e4_row6_col3, #T_672e4_row7_col0, #T_672e4_row7_col1, #T_672e4_row7_col2, #T_672e4_row7_col3, #T_672e4_row8_col0, #T_672e4_row8_col1, #T_672e4_row8_col2, #T_672e4_row8_col3, #T_672e4_row9_col0, #T_672e4_row9_col1, #T_672e4_row9_col2, #T_672e4_row9_col3 {
  text-align: left;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-width: 400px;
}
</style>

<table id="T_672e4" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_672e4_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">question</th>
<th id="T_672e4_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">example_answer</th>
<th id="T_672e4_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">pred_answer</th>
<th id="T_672e4_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">eval_metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_672e4_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_672e4_row0_col0" class="data row0 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row0_col1" class="data row0 col1">(A)</td>
<td id="T_672e4_row0_col2" class="data row0 col2">3</td>
<td id="T_672e4_row0_col3" class="data row0 col3">False</td>
</tr>
<tr class="even">
<td id="T_672e4_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_672e4_row1_col0" class="data row1 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row1_col1" class="data row1 col1">(D)</td>
<td id="T_672e4_row1_col2" class="data row1 col2">(C) 50</td>
<td id="T_672e4_row1_col3" class="data row1 col3">False</td>
</tr>
<tr class="odd">
<td id="T_672e4_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_672e4_row2_col0" class="data row2 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row2_col1" class="data row2 col1">(A)</td>
<td id="T_672e4_row2_col2" class="data row2 col2">Answer: (C) 3</td>
<td id="T_672e4_row2_col3" class="data row2 col3">False</td>
</tr>
<tr class="even">
<td id="T_672e4_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_672e4_row3_col0" class="data row3 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row3_col1" class="data row3 col1">(A)</td>
<td id="T_672e4_row3_col2" class="data row3 col2">Answer: (B) 2</td>
<td id="T_672e4_row3_col3" class="data row3 col3">False</td>
</tr>
<tr class="odd">
<td id="T_672e4_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_672e4_row4_col0" class="data row4 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row4_col1" class="data row4 col1">(B)</td>
<td id="T_672e4_row4_col2" class="data row4 col2">(B) 5</td>
<td id="T_672e4_row4_col3" class="data row4 col3">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_672e4_level0_row5" class="row_heading level0 row5" data-quarto-table-cell-role="th">5</td>
<td id="T_672e4_row5_col0" class="data row5 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row5_col1" class="data row5 col1">(C)</td>
<td id="T_672e4_row5_col2" class="data row5 col2">(B) 2</td>
<td id="T_672e4_row5_col3" class="data row5 col3">False</td>
</tr>
<tr class="odd">
<td id="T_672e4_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">6</td>
<td id="T_672e4_row6_col0" class="data row6 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row6_col1" class="data row6 col1">(E)</td>
<td id="T_672e4_row6_col2" class="data row6 col2">James</td>
<td id="T_672e4_row6_col3" class="data row6 col3">False</td>
</tr>
<tr class="even">
<td id="T_672e4_level0_row7" class="row_heading level0 row7" data-quarto-table-cell-role="th">7</td>
<td id="T_672e4_row7_col0" class="data row7 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row7_col1" class="data row7 col1">(A)</td>
<td id="T_672e4_row7_col2" class="data row7 col2">(B) 2</td>
<td id="T_672e4_row7_col3" class="data row7 col3">False</td>
</tr>
<tr class="odd">
<td id="T_672e4_level0_row8" class="row_heading level0 row8" data-quarto-table-cell-role="th">8</td>
<td id="T_672e4_row8_col0" class="data row8 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row8_col1" class="data row8 col1">(C)</td>
<td id="T_672e4_row8_col2" class="data row8 col2">Answer: Vincent</td>
<td id="T_672e4_row8_col3" class="data row8 col3">False</td>
</tr>
<tr class="even">
<td id="T_672e4_level0_row9" class="row_heading level0 row9" data-quarto-table-cell-role="th">9</td>
<td id="T_672e4_row9_col0" class="data row9 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_672e4_row9_col1" class="data row9 col1">(D)</td>
<td id="T_672e4_row9_col2" class="data row9 col2">Answer: Donna</td>
<td id="T_672e4_row9_col3" class="data row9 col3">False</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

                <div style="
                    text-align: center; 
                    font-size: 16px; 
                    font-weight: bold; 
                    color: #555; 
                    margin: 10px 0;">
                    ... 116 more rows not displayed ...
                </div>
                
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>34.92</code></pre>
</div>
</div>
<p><code>DSPy</code> uses optimizers to optimize the modules. In this example, optimization is a process that will choose which demos/examples are best to put into the prompt in order to increase the evaluation metric. At the time of writing the optimizers are called teleprompters (prompting from a distance). I think they will change the <a href="https://dspy-docs.vercel.app/docs/building-blocks/optimizers">name</a> though to optimizers in future refactoring. The DSPy documentation states that the optimizer can adjust/edit:</p>
<ul>
<li>Demo examples in the prompt.</li>
<li>Instructions of the prompt.</li>
<li>Weights of the actual LLM (for example fine tuning an open source model).</li>
</ul>
<p>I have only played around with optimizers that optimize which demos/examples are put into the prompt.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:45.592928Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:44.748388Z&quot;}" data-execution_count="16">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.teleprompt <span class="im">import</span> BootstrapFewShotWithRandomSearch</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> <span class="bu">dict</span>(max_bootstrapped_demos<span class="op">=</span><span class="dv">2</span>, max_labeled_demos<span class="op">=</span><span class="dv">4</span>, num_candidate_programs<span class="op">=</span><span class="dv">2</span>, num_threads<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>teleprompter <span class="op">=</span> BootstrapFewShotWithRandomSearch(metric<span class="op">=</span>eval_metric, <span class="op">**</span>config)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>optimized_qa <span class="op">=</span> teleprompter.<span class="bu">compile</span>(basic_qa, trainset<span class="op">=</span>trainset, valset<span class="op">=</span>valset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>There is a lot of output from the above code block which I am hiding to keep things cleaner. You can now evaluate the optimized model to see if the accuracy has improved.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:45.818831Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:45.542066Z&quot;}" data-execution_count="17">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>evaluate(optimized_qa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 54 / 126  (42.9%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_07434 th {
  text-align: left;
}
#T_07434 td {
  text-align: left;
}
#T_07434_row0_col0, #T_07434_row0_col1, #T_07434_row0_col2, #T_07434_row0_col3, #T_07434_row1_col0, #T_07434_row1_col1, #T_07434_row1_col2, #T_07434_row1_col3, #T_07434_row2_col0, #T_07434_row2_col1, #T_07434_row2_col2, #T_07434_row2_col3, #T_07434_row3_col0, #T_07434_row3_col1, #T_07434_row3_col2, #T_07434_row3_col3, #T_07434_row4_col0, #T_07434_row4_col1, #T_07434_row4_col2, #T_07434_row4_col3, #T_07434_row5_col0, #T_07434_row5_col1, #T_07434_row5_col2, #T_07434_row5_col3, #T_07434_row6_col0, #T_07434_row6_col1, #T_07434_row6_col2, #T_07434_row6_col3, #T_07434_row7_col0, #T_07434_row7_col1, #T_07434_row7_col2, #T_07434_row7_col3, #T_07434_row8_col0, #T_07434_row8_col1, #T_07434_row8_col2, #T_07434_row8_col3, #T_07434_row9_col0, #T_07434_row9_col1, #T_07434_row9_col2, #T_07434_row9_col3 {
  text-align: left;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-width: 400px;
}
</style>

<table id="T_07434" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_07434_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">question</th>
<th id="T_07434_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">example_answer</th>
<th id="T_07434_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">pred_answer</th>
<th id="T_07434_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">eval_metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_07434_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_07434_row0_col0" class="data row0 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row0_col1" class="data row0 col1">(A)</td>
<td id="T_07434_row0_col2" class="data row0 col2">(C)</td>
<td id="T_07434_row0_col3" class="data row0 col3">False</td>
</tr>
<tr class="even">
<td id="T_07434_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_07434_row1_col0" class="data row1 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row1_col1" class="data row1 col1">(D)</td>
<td id="T_07434_row1_col2" class="data row1 col2">(C) 50</td>
<td id="T_07434_row1_col3" class="data row1 col3">False</td>
</tr>
<tr class="odd">
<td id="T_07434_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_07434_row2_col0" class="data row2 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row2_col1" class="data row2 col1">(A)</td>
<td id="T_07434_row2_col2" class="data row2 col2">(B)</td>
<td id="T_07434_row2_col3" class="data row2 col3">False</td>
</tr>
<tr class="even">
<td id="T_07434_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_07434_row3_col0" class="data row3 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row3_col1" class="data row3 col1">(A)</td>
<td id="T_07434_row3_col2" class="data row3 col2">(B)</td>
<td id="T_07434_row3_col3" class="data row3 col3">False</td>
</tr>
<tr class="odd">
<td id="T_07434_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_07434_row4_col0" class="data row4 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row4_col1" class="data row4 col1">(B)</td>
<td id="T_07434_row4_col2" class="data row4 col2">(B)</td>
<td id="T_07434_row4_col3" class="data row4 col3">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_07434_level0_row5" class="row_heading level0 row5" data-quarto-table-cell-role="th">5</td>
<td id="T_07434_row5_col0" class="data row5 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row5_col1" class="data row5 col1">(C)</td>
<td id="T_07434_row5_col2" class="data row5 col2">(C)</td>
<td id="T_07434_row5_col3" class="data row5 col3">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_07434_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">6</td>
<td id="T_07434_row6_col0" class="data row6 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row6_col1" class="data row6 col1">(E)</td>
<td id="T_07434_row6_col2" class="data row6 col2">(D)</td>
<td id="T_07434_row6_col3" class="data row6 col3">False</td>
</tr>
<tr class="even">
<td id="T_07434_level0_row7" class="row_heading level0 row7" data-quarto-table-cell-role="th">7</td>
<td id="T_07434_row7_col0" class="data row7 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row7_col1" class="data row7 col1">(A)</td>
<td id="T_07434_row7_col2" class="data row7 col2">(B)</td>
<td id="T_07434_row7_col3" class="data row7 col3">False</td>
</tr>
<tr class="odd">
<td id="T_07434_level0_row8" class="row_heading level0 row8" data-quarto-table-cell-role="th">8</td>
<td id="T_07434_row8_col0" class="data row8 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row8_col1" class="data row8 col1">(C)</td>
<td id="T_07434_row8_col2" class="data row8 col2">(D) Gwen</td>
<td id="T_07434_row8_col3" class="data row8 col3">False</td>
</tr>
<tr class="even">
<td id="T_07434_level0_row9" class="row_heading level0 row9" data-quarto-table-cell-role="th">9</td>
<td id="T_07434_row9_col0" class="data row9 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_07434_row9_col1" class="data row9 col1">(D)</td>
<td id="T_07434_row9_col2" class="data row9 col2">(D) Donna</td>
<td id="T_07434_row9_col3" class="data row9 col3">✔️ [True]</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

                <div style="
                    text-align: center; 
                    font-size: 16px; 
                    font-weight: bold; 
                    color: #555; 
                    margin: 10px 0;">
                    ... 116 more rows not displayed ...
                </div>
                
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>42.86</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:45.818962Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:45.655073Z&quot;}" data-execution_count="18">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>llm.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>



Given the fields `question`, produce the fields `answer`.

---

Follow the following format.

Question: ${question}
Answer: ${answer}

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. And here is a similar table, but listing giraffes: name, age, height (cm), weight (kg) Jody, 5, 430, 620 Gladys, 10, 420, 590 Marian, 2, 310, 410 Donna, 9, 440, 650 How many giraffes are more than 5 years old? Options: (A) 1 (B) 2 (C) 3 (D) 4 (E) 5
Answer: (B)

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. What is the name of the last penguin sorted by alphabetic order? Options: (A) Louis (B) Bernard (C) Vincent (D) Gwen (E) James
Answer: (C)

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. We now add a penguin to the table: James, 12, 90, 12 We then delete the penguin named Bernard from the table. How many penguins are more than 5 years old and weight more than 12 kg? Options: (A) 1 (B) 2 (C) 3 (D) 4 (E) 5
Answer: (A)

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. How many animals are listed in the table? Options: (A) 1 (B) 2 (C) 3 (D) 4 (E) 5
Answer: (D)

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. Which is the second heaviest penguin? Options: (A) Louis (B) Bernard (C) Vincent (D) Gwen (E) James
Answer: (B) Bernard

</code></pre>
</div>
</div>
<p>Now we can try a <a href="https://arxiv.org/abs/2201.11903">Chain of Thought</a> <span class="citation" data-cites="wei2023chainofthought">(<a href="#ref-wei2023chainofthought" role="doc-biblioref">Wei et al. 2023</a>)</span> prompt.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:45.818998Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:45.658305Z&quot;}" data-execution_count="19">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CoT(dspy.Module):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.prog <span class="op">=</span> dspy.ChainOfThought(<span class="st">"question -&gt; answer"</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, question):</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.prog(question<span class="op">=</span>question)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>cot_qa <span class="op">=</span> CoT()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:45.897545Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:45.660465Z&quot;}" data-execution_count="20">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>evaluate(cot_qa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 90 / 126  (71.4%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_23ae3 th {
  text-align: left;
}
#T_23ae3 td {
  text-align: left;
}
#T_23ae3_row0_col0, #T_23ae3_row0_col1, #T_23ae3_row0_col2, #T_23ae3_row0_col3, #T_23ae3_row0_col4, #T_23ae3_row1_col0, #T_23ae3_row1_col1, #T_23ae3_row1_col2, #T_23ae3_row1_col3, #T_23ae3_row1_col4, #T_23ae3_row2_col0, #T_23ae3_row2_col1, #T_23ae3_row2_col2, #T_23ae3_row2_col3, #T_23ae3_row2_col4, #T_23ae3_row3_col0, #T_23ae3_row3_col1, #T_23ae3_row3_col2, #T_23ae3_row3_col3, #T_23ae3_row3_col4, #T_23ae3_row4_col0, #T_23ae3_row4_col1, #T_23ae3_row4_col2, #T_23ae3_row4_col3, #T_23ae3_row4_col4, #T_23ae3_row5_col0, #T_23ae3_row5_col1, #T_23ae3_row5_col2, #T_23ae3_row5_col3, #T_23ae3_row5_col4, #T_23ae3_row6_col0, #T_23ae3_row6_col1, #T_23ae3_row6_col2, #T_23ae3_row6_col3, #T_23ae3_row6_col4, #T_23ae3_row7_col0, #T_23ae3_row7_col1, #T_23ae3_row7_col2, #T_23ae3_row7_col3, #T_23ae3_row7_col4, #T_23ae3_row8_col0, #T_23ae3_row8_col1, #T_23ae3_row8_col2, #T_23ae3_row8_col3, #T_23ae3_row8_col4, #T_23ae3_row9_col0, #T_23ae3_row9_col1, #T_23ae3_row9_col2, #T_23ae3_row9_col3, #T_23ae3_row9_col4 {
  text-align: left;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-width: 400px;
}
</style>

<table id="T_23ae3" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_23ae3_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">question</th>
<th id="T_23ae3_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">example_answer</th>
<th id="T_23ae3_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">rationale</th>
<th id="T_23ae3_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">pred_answer</th>
<th id="T_23ae3_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">eval_metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_23ae3_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_23ae3_row0_col0" class="data row0 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row0_col1" class="data row0 col1">(A)</td>
<td id="T_23ae3_row0_col2" class="data row0 col2">produce the answer. We first identify the penguins who are less than 8 years old. From the table, we see that Louis is 7 years...</td>
<td id="T_23ae3_row0_col3" class="data row0 col3">(B) 2</td>
<td id="T_23ae3_row0_col4" class="data row0 col4">False</td>
</tr>
<tr class="even">
<td id="T_23ae3_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_23ae3_row1_col0" class="data row1 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row1_col1" class="data row1 col1">(D)</td>
<td id="T_23ae3_row1_col2" class="data row1 col2">produce the answer. We need to add up the weights of all the penguins in the table. Louis weighs 11 kg, Bernard weighs 13 kg,...</td>
<td id="T_23ae3_row1_col3" class="data row1 col3">(D) 62</td>
<td id="T_23ae3_row1_col4" class="data row1 col4">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_23ae3_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_23ae3_row2_col0" class="data row2 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row2_col1" class="data row2 col1">(A)</td>
<td id="T_23ae3_row2_col2" class="data row2 col2">produce the answer. We need to go through each penguin's age and count how many are more than 8 years old.</td>
<td id="T_23ae3_row2_col3" class="data row2 col3">(C) 3</td>
<td id="T_23ae3_row2_col4" class="data row2 col4">False</td>
</tr>
<tr class="even">
<td id="T_23ae3_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_23ae3_row3_col0" class="data row3 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row3_col1" class="data row3 col1">(A)</td>
<td id="T_23ae3_row3_col2" class="data row3 col2">produce the answer. We need to identify the penguins who are both more than 5 years old and weigh more than 12 kg. Looking at...</td>
<td id="T_23ae3_row3_col3" class="data row3 col3">(C) 3</td>
<td id="T_23ae3_row3_col4" class="data row3 col4">False</td>
</tr>
<tr class="odd">
<td id="T_23ae3_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_23ae3_row4_col0" class="data row4 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row4_col1" class="data row4 col1">(B)</td>
<td id="T_23ae3_row4_col2" class="data row4 col2">produce the answer. We can see from the table that Bernard's age is 5.</td>
<td id="T_23ae3_row4_col3" class="data row4 col3">(B) 5</td>
<td id="T_23ae3_row4_col4" class="data row4 col4">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_23ae3_level0_row5" class="row_heading level0 row5" data-quarto-table-cell-role="th">5</td>
<td id="T_23ae3_row5_col0" class="data row5 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row5_col1" class="data row5 col1">(C)</td>
<td id="T_23ae3_row5_col2" class="data row5 col2">produce the answer. We first identify the penguins who are less than 10 years old. Louis is 7 years old, Bernard is 5 years old,...</td>
<td id="T_23ae3_row5_col3" class="data row5 col3">(D) 4</td>
<td id="T_23ae3_row5_col4" class="data row5 col4">False</td>
</tr>
<tr class="odd">
<td id="T_23ae3_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">6</td>
<td id="T_23ae3_row6_col0" class="data row6 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row6_col1" class="data row6 col1">(E)</td>
<td id="T_23ae3_row6_col2" class="data row6 col2">produce the answer. We need to identify the last penguin added to the table. By looking at the last entry in the penguin table, we...</td>
<td id="T_23ae3_row6_col3" class="data row6 col3">James</td>
<td id="T_23ae3_row6_col4" class="data row6 col4">False</td>
</tr>
<tr class="even">
<td id="T_23ae3_level0_row7" class="row_heading level0 row7" data-quarto-table-cell-role="th">7</td>
<td id="T_23ae3_row7_col0" class="data row7 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row7_col1" class="data row7 col1">(A)</td>
<td id="T_23ae3_row7_col2" class="data row7 col2">produce the answer. We first need to identify the penguins who are more than 5 years old and weigh more than 12 kg. From the...</td>
<td id="T_23ae3_row7_col3" class="data row7 col3">(A) 1</td>
<td id="T_23ae3_row7_col4" class="data row7 col4">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_23ae3_level0_row8" class="row_heading level0 row8" data-quarto-table-cell-role="th">8</td>
<td id="T_23ae3_row8_col0" class="data row8 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row8_col1" class="data row8 col1">(C)</td>
<td id="T_23ae3_row8_col2" class="data row8 col2">produce the answer. We need to find the penguin with a height of 60 cm. Looking at the table, we see that Vincent is the...</td>
<td id="T_23ae3_row8_col3" class="data row8 col3">(C) Vincent</td>
<td id="T_23ae3_row8_col4" class="data row8 col4">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_23ae3_level0_row9" class="row_heading level0 row9" data-quarto-table-cell-role="th">9</td>
<td id="T_23ae3_row9_col0" class="data row9 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_23ae3_row9_col1" class="data row9 col1">(D)</td>
<td id="T_23ae3_row9_col2" class="data row9 col2">produce the answer. We need to look at the last entry in the table listing giraffes. The last giraffe listed is Donna.</td>
<td id="T_23ae3_row9_col3" class="data row9 col3">(D) Donna</td>
<td id="T_23ae3_row9_col4" class="data row9 col4">✔️ [True]</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

                <div style="
                    text-align: center; 
                    font-size: 16px; 
                    font-weight: bold; 
                    color: #555; 
                    margin: 10px 0;">
                    ... 116 more rows not displayed ...
                </div>
                
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>71.43</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:45.897781Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:45.777422Z&quot;}" data-execution_count="21">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>llm.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>



Given the fields `question`, produce the fields `answer`.

---

Follow the following format.

Question: ${question}
Reasoning: Let's think step by step in order to ${produce the answer}. We ...
Answer: ${answer}

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. We now add a penguin to the table: James, 12, 90, 12 Which penguin is taller than the other ones? Options: (A) Louis (B) Bernard (C) Vincent (D) Gwen (E) James
Reasoning: Let's think step by step in order to produce the answer. We need to compare the height of each penguin in the table and determine which one is the tallest. Louis is 50 cm tall, Bernard is 80 cm tall, Vincent is 60 cm tall, Gwen is 70 cm tall, and James is 90 cm tall. Therefore, James is taller than all the other penguins.
Answer: (E) James

</code></pre>
</div>
</div>
<p>Now we will try and optimize our chain of thought program. I am also hiding the output from this cell to keep things cleaner.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:46.912484Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:45.781011Z&quot;}" data-execution_count="23">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>tqdm._instances.clear()</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> <span class="bu">dict</span>(max_bootstrapped_demos<span class="op">=</span><span class="dv">1</span>, max_labeled_demos<span class="op">=</span><span class="dv">4</span>, num_candidate_programs<span class="op">=</span><span class="dv">4</span>, num_threads<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>teleprompter <span class="op">=</span> BootstrapFewShotWithRandomSearch(metric<span class="op">=</span>eval_metric, <span class="op">**</span>config)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>optimized_cot_qa <span class="op">=</span> teleprompter.<span class="bu">compile</span>(cot_qa, trainset<span class="op">=</span>trainset, valset<span class="op">=</span>valset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:46.938454Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:46.723574Z&quot;}" data-execution_count="24">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>evaluate(optimized_cot_qa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 102 / 126  (81.0%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_0dbba th {
  text-align: left;
}
#T_0dbba td {
  text-align: left;
}
#T_0dbba_row0_col0, #T_0dbba_row0_col1, #T_0dbba_row0_col2, #T_0dbba_row0_col3, #T_0dbba_row0_col4, #T_0dbba_row1_col0, #T_0dbba_row1_col1, #T_0dbba_row1_col2, #T_0dbba_row1_col3, #T_0dbba_row1_col4, #T_0dbba_row2_col0, #T_0dbba_row2_col1, #T_0dbba_row2_col2, #T_0dbba_row2_col3, #T_0dbba_row2_col4, #T_0dbba_row3_col0, #T_0dbba_row3_col1, #T_0dbba_row3_col2, #T_0dbba_row3_col3, #T_0dbba_row3_col4, #T_0dbba_row4_col0, #T_0dbba_row4_col1, #T_0dbba_row4_col2, #T_0dbba_row4_col3, #T_0dbba_row4_col4, #T_0dbba_row5_col0, #T_0dbba_row5_col1, #T_0dbba_row5_col2, #T_0dbba_row5_col3, #T_0dbba_row5_col4, #T_0dbba_row6_col0, #T_0dbba_row6_col1, #T_0dbba_row6_col2, #T_0dbba_row6_col3, #T_0dbba_row6_col4, #T_0dbba_row7_col0, #T_0dbba_row7_col1, #T_0dbba_row7_col2, #T_0dbba_row7_col3, #T_0dbba_row7_col4, #T_0dbba_row8_col0, #T_0dbba_row8_col1, #T_0dbba_row8_col2, #T_0dbba_row8_col3, #T_0dbba_row8_col4, #T_0dbba_row9_col0, #T_0dbba_row9_col1, #T_0dbba_row9_col2, #T_0dbba_row9_col3, #T_0dbba_row9_col4 {
  text-align: left;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-width: 400px;
}
</style>

<table id="T_0dbba" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_0dbba_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">question</th>
<th id="T_0dbba_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">example_answer</th>
<th id="T_0dbba_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">rationale</th>
<th id="T_0dbba_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">pred_answer</th>
<th id="T_0dbba_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">eval_metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_0dbba_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_0dbba_row0_col0" class="data row0 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row0_col1" class="data row0 col1">(A)</td>
<td id="T_0dbba_row0_col2" class="data row0 col2">produce the answer. After deleting Bernard, the penguins left are Louis, Vincent, and Gwen. Among them, Louis and Gwen are less than 8 years old.</td>
<td id="T_0dbba_row0_col3" class="data row0 col3">(B) 2</td>
<td id="T_0dbba_row0_col4" class="data row0 col4">False</td>
</tr>
<tr class="even">
<td id="T_0dbba_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_0dbba_row1_col0" class="data row1 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row1_col1" class="data row1 col1">(D)</td>
<td id="T_0dbba_row1_col2" class="data row1 col2">produce the answer. We sum up the weights of all the penguins: 11 + 13 + 11 + 15 + 12 = 62.</td>
<td id="T_0dbba_row1_col3" class="data row1 col3">(D) 62</td>
<td id="T_0dbba_row1_col4" class="data row1 col4">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_0dbba_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_0dbba_row2_col0" class="data row2 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row2_col1" class="data row2 col1">(A)</td>
<td id="T_0dbba_row2_col2" class="data row2 col2">produce the answer. We know that after deleting Bernard, the penguins left are Louis, Vincent, and Gwen. Among them, only Vincent is more than 8...</td>
<td id="T_0dbba_row2_col3" class="data row2 col3">(A) 1</td>
<td id="T_0dbba_row2_col4" class="data row2 col4">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_0dbba_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_0dbba_row3_col0" class="data row3 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row3_col1" class="data row3 col1">(A)</td>
<td id="T_0dbba_row3_col2" class="data row3 col2">produce the answer. We have Louis, Vincent, Gwen, and James in the table. Among them, only James is more than 5 years old and weighs...</td>
<td id="T_0dbba_row3_col3" class="data row3 col3">(A) 1</td>
<td id="T_0dbba_row3_col4" class="data row3 col4">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_0dbba_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_0dbba_row4_col0" class="data row4 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row4_col1" class="data row4 col1">(B)</td>
<td id="T_0dbba_row4_col2" class="data row4 col2">produce the answer. We know that the age of Bernard is 5 years old.</td>
<td id="T_0dbba_row4_col3" class="data row4 col3">(B) 5</td>
<td id="T_0dbba_row4_col4" class="data row4 col4">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_0dbba_level0_row5" class="row_heading level0 row5" data-quarto-table-cell-role="th">5</td>
<td id="T_0dbba_row5_col0" class="data row5 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row5_col1" class="data row5 col1">(C)</td>
<td id="T_0dbba_row5_col2" class="data row5 col2">produce the answer. We know that after deleting Bernard, the penguins left are Louis, Vincent, and Gwen. Among them, Louis and Gwen are less than...</td>
<td id="T_0dbba_row5_col3" class="data row5 col3">(B) 2</td>
<td id="T_0dbba_row5_col4" class="data row5 col4">False</td>
</tr>
<tr class="odd">
<td id="T_0dbba_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">6</td>
<td id="T_0dbba_row6_col0" class="data row6 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row6_col1" class="data row6 col1">(E)</td>
<td id="T_0dbba_row6_col2" class="data row6 col2">produce the answer. We know that the last penguin added to the table is James.</td>
<td id="T_0dbba_row6_col3" class="data row6 col3">(E) James</td>
<td id="T_0dbba_row6_col4" class="data row6 col4">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_0dbba_level0_row7" class="row_heading level0 row7" data-quarto-table-cell-role="th">7</td>
<td id="T_0dbba_row7_col0" class="data row7 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row7_col1" class="data row7 col1">(A)</td>
<td id="T_0dbba_row7_col2" class="data row7 col2">produce the answer. After deleting Bernard, we are left with Louis, Vincent, and Gwen. Among them, only Gwen is more than 5 years old and...</td>
<td id="T_0dbba_row7_col3" class="data row7 col3">(A) 1</td>
<td id="T_0dbba_row7_col4" class="data row7 col4">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_0dbba_level0_row8" class="row_heading level0 row8" data-quarto-table-cell-role="th">8</td>
<td id="T_0dbba_row8_col0" class="data row8 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row8_col1" class="data row8 col1">(C)</td>
<td id="T_0dbba_row8_col2" class="data row8 col2">produce the answer. We know that the only penguin with a height of 60 cm is Vincent.</td>
<td id="T_0dbba_row8_col3" class="data row8 col3">(C) Vincent</td>
<td id="T_0dbba_row8_col4" class="data row8 col4">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_0dbba_level0_row9" class="row_heading level0 row9" data-quarto-table-cell-role="th">9</td>
<td id="T_0dbba_row9_col0" class="data row9 col0">Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis,...</td>
<td id="T_0dbba_row9_col1" class="data row9 col1">(D)</td>
<td id="T_0dbba_row9_col2" class="data row9 col2">produce the answer. We know that the last giraffe listed is Donna.</td>
<td id="T_0dbba_row9_col3" class="data row9 col3">(D) Donna</td>
<td id="T_0dbba_row9_col4" class="data row9 col4">✔️ [True]</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

                <div style="
                    text-align: center; 
                    font-size: 16px; 
                    font-weight: bold; 
                    color: #555; 
                    margin: 10px 0;">
                    ... 116 more rows not displayed ...
                </div>
                
</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>80.95</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-02-13T21:02:46.938648Z&quot;,&quot;start_time&quot;:&quot;2024-02-13T21:02:46.782022Z&quot;}" data-execution_count="25">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>llm.inspect_history(n<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>



Given the fields `question`, produce the fields `answer`.

---

Follow the following format.

Question: ${question}
Reasoning: Let's think step by step in order to ${produce the answer}. We ...
Answer: ${answer}

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. We then delete the penguin named Bernard from the table. How many penguins are more than 8 years old? Options: (A) 1 (B) 2 (C) 3 (D) 4 (E) 5
Reasoning: Let's think step by step in order to produce the answer. We know that after deleting Bernard, the penguins left are Louis, Vincent, and Gwen. Among them, only Vincent is more than 8 years old.
Answer: (A) 1

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. How many penguins are more than 5 years old? Options: (A) 1 (B) 2 (C) 3 (D) 4 (E) 5
Answer: (C)

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. And here is a similar table, but listing giraffes: name, age, height (cm), weight (kg) Jody, 5, 430, 620 Gladys, 10, 420, 590 Marian, 2, 310, 410 Donna, 9, 440, 650 How many animals are more than 5 years old? Options: (A) 5 (B) 6 (C) 7 (D) 8 (E) 9
Answer: (A)

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. Which penguin is older than Gwen? Options: (A) Louis (B) Bernard (C) Vincent (D) Gwen (E) James
Answer: (C)

---

Question: Here is a table where the first line is a header and each subsequent line is a penguin: name, age, height (cm), weight (kg) Louis, 7, 50, 11 Bernard, 5, 80, 13 Vincent, 9, 60, 11 Gwen, 8, 70, 15 For example: the age of Louis is 7, the weight of Gwen is 15 kg, the height of Bernard is 80 cm. We then delete the penguin named Bernard from the table. What is the name of the last penguin sorted by alphabetic order? Options: (A) Louis (B) Bernard (C) Vincent (D) Gwen (E) James
Reasoning: Let's think step by step in order to produce the answer. After deleting Bernard, the remaining penguins are Louis, Vincent, and Gwen. Sorting them alphabetically, the last penguin is Vincent.
Answer: (C) Vincent

</code></pre>
</div>
</div>
<p>It’s really nice that the above focused on:</p>
<ul>
<li>Writing small modules/programs.</li>
<li>Choosing an optimizer.</li>
<li>Running the compile/optimization step.</li>
<li>Running an evaluation.</li>
</ul>
<p>I really like this idea instead of manually writing prompts and hoping for the best.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-khattab2023dspy" class="csl-entry" role="listitem">
Khattab, Omar, Arnav Singhvi, Paridhi Maheshwari, Zhiyuan Zhang, Keshav Santhanam, Sri Vardhamanan, Saiful Haq, et al. 2023. <span>“DSPy: Compiling Declarative Language Model Calls into Self-Improving Pipelines.”</span> <a href="https://arxiv.org/abs/2310.03714">https://arxiv.org/abs/2310.03714</a>.
</div>
<div id="ref-singhvi2024dspy" class="csl-entry" role="listitem">
Singhvi, Arnav, Manish Shetty, Shangyin Tan, Christopher Potts, Koushik Sen, Matei Zaharia, and Omar Khattab. 2024. <span>“DSPy Assertions: Computational Constraints for Self-Refining Language Model Pipelines.”</span> <a href="https://arxiv.org/abs/2312.13382">https://arxiv.org/abs/2312.13382</a>.
</div>
<div id="ref-suzgun2022challenging" class="csl-entry" role="listitem">
Suzgun, Mirac, Nathan Scales, Nathanael Schärli, Sebastian Gehrmann, Yi Tay, Hyung Won Chung, Aakanksha Chowdhery, et al. 2022. <span>“Challenging BIG-Bench Tasks and Whether Chain-of-Thought Can Solve Them.”</span> <em>arXiv Preprint arXiv:2210.09261</em>.
</div>
<div id="ref-wei2023chainofthought" class="csl-entry" role="listitem">
Wei, Jason, Xuezhi Wang, Dale Schuurmans, Maarten Bosma, Brian Ichter, Fei Xia, Ed Chi, Quoc Le, and Denny Zhou. 2023. <span>“Chain-of-Thought Prompting Elicits Reasoning in Large Language Models.”</span> <a href="https://arxiv.org/abs/2201.11903">https://arxiv.org/abs/2201.11903</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>